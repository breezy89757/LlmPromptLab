@page "/"
@using LlmPocApp.Components
@using LlmPocApp.Services
@inject PromptGenerationService PromptService
@inject EvaluationService EvaluationService

<div class="lab-container">
    <div class="lab-input-panel">
        <div class="panel-header">
            <h3>ğŸ§ª æç¤ºè©å¯¦é©—å®¤</h3>
            <span class="version-tag">v0.1</span>
        </div>

        <div class="form-group">
            <label>ğŸ¯ æ©Ÿå™¨äººç›®æ¨™ / ä¸Šä¸‹æ–‡</label>
            <textarea @bind="goal" class="input-goal" placeholder="æè¿°æ‚¨å¸Œæœ›æ©Ÿå™¨äººåšä»€éº¼... (ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€å€‹æ†¤ä¸–å«‰ä¿—çš„å¤©æ°£æ©Ÿå™¨äººï¼Œè¨å­ä¸‹é›¨)"></textarea>
        </div>

        <div class="example-grid">
            <div class="form-group">
                 <label>ğŸ‘¤ é æœŸä½¿ç”¨è€…è¼¸å…¥</label>
                 <textarea @bind="expectedInput" placeholder="User: ä»Šå¤©å¤©æ°£å¦‚ä½•ï¼Ÿ"></textarea>
            </div>

            <div class="form-group">
                 <label>ğŸ¤– é æœŸå›ç­” (æ¨™æº–ç­”æ¡ˆ)</label>
                 <textarea @bind="expectedOutput" placeholder="Assistant: å”‰ï¼Œåˆåœ¨ä¸‹é›¨äº†ï¼Œé€™ç¨®äº‹é‚„è¦å•å—ï¼Ÿ"></textarea>
            </div>
            
            @if (evaluationResult != null)
            {
                <div class="evaluation-result @(evaluationResult.Score >= 70 ? "pass" : "fail")">
                    <div class="result-header">
                        <span class="score-badge">@evaluationResult.Score åˆ†</span>
                        <span class="result-label">AI è©•é‘‘</span>
                    </div>
                    <p class="reasoning">@evaluationResult.Reasoning</p>
                </div>
            }
        </div>
        
        <div class="action-buttons">
            <button class="btn-generate" @onclick="GeneratePrompt" disabled="@(isGenerating || isTesting || string.IsNullOrWhiteSpace(goal))">
                @(isGenerating ? "âœ¨ ç”Ÿæˆä¸­..." : "âœ¨ ç”Ÿæˆ System Prompt")
            </button>
            <button class="btn-test" @onclick="RunTest" disabled="@(isGenerating || isTesting || string.IsNullOrWhiteSpace(expectedInput))">
                @(isTesting ? "â³ æ¸¬è©¦ä¸­..." : "ğŸ§ª åŸ·è¡Œæ¸¬è©¦")
            </button>
        </div>
    </div>

    <div class="lab-chat-panel">
        <ChatPanel @ref="chatPanel"
                   ExternalSystemPrompt="@generatedSystemPrompt" 
                   OnResponseReceived="OnChatResponseReceived" />
    </div>
</div>

@code {
    private string goal = "";
    private string expectedInput = "";
    private string expectedOutput = "";
    private string? generatedSystemPrompt;
    
    private bool isGenerating = false;
    private bool isTesting = false;
    private EvaluationResult? evaluationResult;
    
    private ChatPanel? chatPanel;

    private async Task GeneratePrompt()
    {
        isGenerating = true;
        evaluationResult = null; // Clear previous result
        StateHasChanged();
        
        try
        {
            generatedSystemPrompt = await PromptService.GenerateSystemPromptAsync(goal, expectedInput, expectedOutput);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isGenerating = false;
        }
    }

    private async Task RunTest()
    {
        if (chatPanel == null || string.IsNullOrWhiteSpace(expectedInput)) return;

        isTesting = true;
        evaluationResult = null;
        StateHasChanged();

        // Trigger chat to send the 'Expected Input' as a user message
        await chatPanel.SendMessage(expectedInput);
    }

    private async Task OnChatResponseReceived(string actualOutput)
    {
        if (isTesting)
        {
            try 
            {
                // Perform Evaluation
                evaluationResult = await EvaluationService.EvaluateAsync(goal, expectedInput, expectedOutput, actualOutput);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Evaluation Error: {ex.Message}");
            }
            finally
            {
                isTesting = false;
                StateHasChanged();
            }
        }
    }
}
